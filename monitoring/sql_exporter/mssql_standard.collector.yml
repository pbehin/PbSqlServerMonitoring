collector_name: mssql_standard

metrics:
  - metric_name: mssql_cpu
    type: gauge
    help: 'SQL Server CPU Usage (%)'
    values: [cpu_sql]
    query: |
      SELECT TOP(1)
        record.value('(./Record/SchedulerMonitorEvent/SystemHealth/SystemIdle)[1]', 'int') as cpu_idle,
        record.value('(./Record/SchedulerMonitorEvent/SystemHealth/ProcessUtilization)[1]', 'int') as cpu_sql
      FROM (
        SELECT TOP(1) [timestamp], CONVERT(xml, record) as record
        FROM sys.dm_os_ring_buffers
        WHERE ring_buffer_type = N'RING_BUFFER_SCHEDULER_MONITOR'
        AND record LIKE '%<SystemHealth>%'
        ORDER BY [timestamp] DESC
      ) as x

  - metric_name: mssql_connections
    type: gauge
    help: 'Total number of user connections'
    values: [UserConnections]
    query: |
      SELECT cntr_value as UserConnections
      FROM sys.dm_os_performance_counters
      WHERE object_name LIKE '%:General Statistics%'
      AND counter_name = 'User Connections'

  - metric_name: mssql_deadlocks
    type: counter
    help: 'Number of deadlocks per second'
    values: [Deadlocks]
    query: |
      SELECT cntr_value as Deadlocks
      FROM sys.dm_os_performance_counters
      WHERE object_name LIKE '%:Locks%'
      AND counter_name = 'Number of Deadlocks/sec'
      AND instance_name = '_Total'

  - metric_name: mssql_batch_requests
    type: counter
    help: 'Number of batch requests per second'
    values: [BatchRequests]
    query: |
      SELECT cntr_value as BatchRequests
      FROM sys.dm_os_performance_counters
      WHERE object_name LIKE '%:SQL Statistics%'
      AND counter_name = 'Batch Requests/sec'

  - metric_name: mssql_page_life_expectancy
    type: gauge
    help: 'Page Life Expectancy in seconds'
    values: [PLE]
    query: |
      SELECT cntr_value as PLE
      FROM sys.dm_os_performance_counters
      WHERE object_name LIKE '%:Buffer Manager%'
      AND counter_name = 'Page life expectancy'

  - metric_name: mssql_buffer_cache
    type: gauge
    help: 'Buffer Cache Hit Ratio'
    values: [BufferCacheHitRatio]
    query: |
      SELECT 
        CAST((a.cntr_value * 1.0 / b.cntr_value) * 100.0 AS decimal(10,2)) as BufferCacheHitRatio
      FROM sys.dm_os_performance_counters a
      JOIN (SELECT cntr_value, object_name FROM sys.dm_os_performance_counters  
            WHERE counter_name = 'Buffer cache hit ratio base') b 
      ON a.object_name = b.object_name
      WHERE a.counter_name = 'Buffer cache hit ratio'
      AND a.object_name LIKE '%:Buffer Manager%'

  - metric_name: mssql_memory
    type: gauge
    help: 'SQL Server Memory Usage (MB)'
    value_label: encoded_value
    values: [total_server_memory_mb, target_server_memory_mb]
    query: |
      SELECT
        (SELECT cntr_value/1024 FROM sys.dm_os_performance_counters WHERE counter_name = 'Total Server Memory (KB)') as total_server_memory_mb,
        (SELECT cntr_value/1024 FROM sys.dm_os_performance_counters WHERE counter_name = 'Target Server Memory (KB)') as target_server_memory_mb

  - metric_name: mssql_database_size
    type: gauge
    help: 'Database size in MB'
    key_labels: [db_name]
    values: [size_mb]
    query: |
      SELECT 
        DB_NAME(database_id) as db_name,
        CAST(SUM(size) * 8. / 1024 AS DECIMAL(10,2)) as size_mb
      FROM sys.master_files
      WHERE DB_NAME(database_id) NOT IN ('master', 'model', 'msdb')
      GROUP BY database_id

  - metric_name: mssql_wait_stats
    type: counter
    help: 'Wait stats by type'
    key_labels: [wait_type]
    value_label: measure
    values: [wait_time_ms, waiting_tasks_count]
    query: |
      SELECT TOP 20
        wait_type,
        wait_time_ms,
        waiting_tasks_count
      FROM sys.dm_os_wait_stats
      WHERE wait_type NOT IN (
        'BROKER_EVENTHANDLER', 'BROKER_RECEIVE_WAITFOR', 'BROKER_TASK_STOP', 'BROKER_TO_FLUSH',
        'BROKER_TRANSMITTER', 'CHECKPOINT_QUEUE', 'CHKPT', 'CLR_AUTO_EVENT', 'CLR_MANUAL_EVENT',
        'CLR_SEMAPHORE', 'DBMIRROR_DBM_EVENT', 'DBMIRROR_EVENTS_QUEUE', 'DBMIRROR_WORKER_QUEUE',
        'DBMIRRORING_CMD', 'DIRTY_PAGE_POLL', 'DISPATCHER_QUEUE_SEMAPHORE', 'EXECSYNC',
        'FSAGENT', 'FT_IFTS_SCHEDULER_IDLE_WAIT', 'FT_IFTSHC_MUTEX', 'HADR_CLUSAPI_CALL',
        'HADR_FILESTREAM_IOMGR_IOCOMPLETION', 'HADR_LOGCAPTURE_WAIT', 'HADR_NOTIFICATION_DEQUEUE',
        'HADR_TIMER_TASK', 'HADR_WORK_QUEUE', 'KSOURCE_WAKEUP', 'LAZYWRITER_SLEEP',
        'LOGMGR_QUEUE', 'MEMORY_ALLOCATION_EXT', 'ONDEMAND_TASK_QUEUE',
        'PREEMPTIVE_XE_GETTARGETSTATE', 'PWAIT_ALL_COMPONENTS_INITIALIZED',
        'PWAIT_DIRECTLOGCONSUMER_GETNEXT', 'QDS_PERSIST_TASK_MAIN_LOOP_SLEEP',
        'QDS_ASYNC_QUEUE', 'QDS_CLEANUP_STALE', 'QDS_SHUTDOWN_QUEUE',
        'REDO_THREAD_PENDING_WORK', 'REQUEST_FOR_DEADLOCK_SEARCH', 'RESOURCE_QUEUE',
        'SERVER_IDLE_CHECK', 'SLEEP_BPOOL_FLUSH', 'SLEEP_DBSTARTUP', 'SLEEP_DCOMSTARTUP',
        'SLEEP_MASTERDBREADY', 'SLEEP_MASTERMDREADY', 'SLEEP_MASTERUPGRADED',
        'SLEEP_MSDBSTARTUP', 'SLEEP_SYSTEMTASK', 'SLEEP_TASK', 'SLEEP_TEMPDBSTARTUP',
        'SNI_HTTP_ACCEPT', 'SP_SERVER_DIAGNOSTICS_SLEEP', 'SQLTRACE_BUFFER_FLUSH',
        'SQLTRACE_INCREMENTAL_FLUSH_SLEEP', 'SQLTRACE_WAIT_ENTRIES', 'WAIT_FOR_RESULTS',
        'WAITFOR', 'WAITFOR_TASKSHUTDOWN', 'HADD_SYNC_COMMIT', 'WRITELOG',
        'XE_DISPATCHER_JOIN', 'XE_DISPATCHER_WAIT', 'XE_TIMER_EVENT'
      )
      ORDER BY wait_time_ms DESC

  # Running queries metric - shows currently executing queries
  - metric_name: mssql_running_queries
    type: gauge
    help: 'Currently running queries count and details'
    key_labels: [session_id, status, command, db_name]
    value_label: metric
    values: [cpu_time, logical_reads, elapsed_time, wait_time]
    query: |
      SELECT
        CAST(session_id AS VARCHAR(10)) as session_id,
        status,
        command,
        ISNULL(DB_NAME(database_id), 'N/A') as db_name,
        cpu_time,
        logical_reads,
        total_elapsed_time as elapsed_time,
        wait_time
      FROM sys.dm_exec_requests WITH (NOLOCK)
      WHERE session_id > 50
        AND status != 'background'
        AND command NOT IN ('AWAITING COMMAND', 'LAZY WRITER', 'CHECKPOINT SLEEP')
        AND DB_NAME(database_id) NOT IN ('master', 'model', 'msdb')

  # Blocking sessions metric - shows blocking chains when they exist
  - metric_name: mssql_blocking_sessions
    type: gauge
    help: 'Blocking sessions with wait time'
    key_labels: [blocked_session_id, blocking_session_id, wait_type, db_name]
    values: [wait_time_seconds]
    query: |
      SELECT
        CAST(blocked.session_id AS VARCHAR(10)) as blocked_session_id,
        CAST(blocked.blocking_session_id AS VARCHAR(10)) as blocking_session_id,
        ISNULL(blocked.wait_type, 'N/A') as wait_type,
        ISNULL(DB_NAME(blocked.database_id), 'N/A') as db_name,
        blocked.wait_time / 1000.0 as wait_time_seconds
      FROM sys.dm_exec_requests blocked WITH (NOLOCK)
      WHERE blocked.blocking_session_id > 0
        AND DB_NAME(blocked.database_id) NOT IN ('master', 'model', 'msdb')

  # Missing indexes metric - top 10 missing indexes by impact
  - metric_name: mssql_missing_indexes
    type: gauge
    help: 'Missing indexes with improvement impact'
    key_labels: [db_name, table_name, equality_columns, inequality_columns, include_columns]
    value_label: metric
    values: [user_seeks, user_scans, avg_user_impact]
    query: |
      SELECT TOP 10
        ISNULL(DB_NAME(d.database_id), 'N/A') as db_name,
        ISNULL(OBJECT_NAME(d.object_id, d.database_id), 'N/A') as table_name,
        ISNULL(d.equality_columns, 'N/A') as equality_columns,
        ISNULL(d.inequality_columns, 'N/A') as inequality_columns,
        ISNULL(d.included_columns, 'N/A') as include_columns,
        gs.user_seeks,
        gs.user_scans,
        gs.avg_user_impact
      FROM sys.dm_db_missing_index_details d WITH (NOLOCK)
      JOIN sys.dm_db_missing_index_groups g WITH (NOLOCK) ON d.index_handle = g.index_handle
      JOIN sys.dm_db_missing_index_group_stats gs WITH (NOLOCK) ON g.index_group_handle = gs.group_handle
      WHERE DB_NAME(d.database_id) NOT IN ('master', 'model', 'msdb', 'tempdb')
      ORDER BY gs.avg_user_impact * (gs.user_seeks + gs.user_scans) DESC

  # Top 10 queries by CPU - uses plan cache for lightweight access
  - metric_name: mssql_top_cpu_queries
    type: gauge
    help: 'Top 10 queries by CPU consumption'
    key_labels: [query_hash, query_text]
    value_label: metric
    values: [total_cpu_time_ms, avg_cpu_time_ms, execution_count, avg_logical_reads]
    query: |
      SELECT TOP 10
        CONVERT(VARCHAR(64), qs.query_hash, 1) as query_hash,
        REPLACE(REPLACE(LEFT(ISNULL(t.text, 'N/A'), 200), CHAR(13), ' '), CHAR(10), ' ') as query_text,
        qs.total_worker_time / 1000 as total_cpu_time_ms,
        (qs.total_worker_time / NULLIF(qs.execution_count, 0)) / 1000 as avg_cpu_time_ms,
        qs.execution_count,
        qs.total_logical_reads / NULLIF(qs.execution_count, 0) as avg_logical_reads
      FROM sys.dm_exec_query_stats qs WITH (NOLOCK)
      CROSS APPLY sys.dm_exec_sql_text(qs.sql_handle) t
      ORDER BY qs.total_worker_time DESC

  # Top 10 queries by I/O - uses plan cache for lightweight access
  - metric_name: mssql_top_io_queries
    type: gauge
    help: 'Top 10 queries by I/O operations'
    key_labels: [query_hash, query_text]
    value_label: metric
    values: [total_logical_reads, total_logical_writes, total_physical_reads, execution_count]
    query: |
      SELECT TOP 10
        CONVERT(VARCHAR(64), qs.query_hash, 1) as query_hash,
        REPLACE(REPLACE(LEFT(ISNULL(t.text, 'N/A'), 200), CHAR(13), ' '), CHAR(10), ' ') as query_text,
        qs.total_logical_reads,
        qs.total_logical_writes,
        qs.total_physical_reads,
        qs.execution_count
      FROM sys.dm_exec_query_stats qs WITH (NOLOCK)
      CROSS APPLY sys.dm_exec_sql_text(qs.sql_handle) t
